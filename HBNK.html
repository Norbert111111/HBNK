<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>@electro-elites</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <link rel="stylesheet" href="style2.css" />
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>
</head>
<body>
   <!-- Version desktop -->
   <div class="main-wrapper">
      <h1 class="hide-on-mobile" style="color: #2343e4;">RESEAU 4.0 DE TRANSPORT ÉLECTRIQUE INTELLIGENT Basée Sur l'IA(AI)  EN R.D.C </h1>
      
      <h2 class="hide-on-mobile" style="color: #2343e4;">              @HBNK.AGK                                                      </h2>

  
  <div class="image-container">
   <img class="hide-on-mobile image-placeholder" src="images/logo1.jpg" alt="Logo1" style="height: 100px; width: 100px; border-radius: 50%; object-fit: cover;">

    <h3 class="title-desktop" style="color: rgb(76, 80, 198); font-size: 22px; margin-top: 10px;">
      <br>INTERFACE DE CONTRÔLE ET D'AFFICHAGE DES DONNÉES DU RESEAU </h3>

    <img class="hide-on-mobile image-placeholder" src="images/logo1.jpg" alt="Logo1" style="height: 100px; width: 100px; border-radius: 50%; object-fit: cover;">

  </div>
  <!-- Version mobile uniquement -->
      
    <div class="title-mobile-wrapper">
     <img src="images/logo1.jpg" alt="Logo1" class="image-placeholder" style="height: 100px;">
       <div class="text-block">
         <span>RESEAU DE TRANSPORT ELEC</span>
        <span>4.0 INTELLIGENT</span>
      </div>
      <h5  style="color: #1408f4;">
    </div>
    <p class="mobile-only">INTERFACE DE CONTRÔLE</p>
      
   


  <div class="table-wrapper">
  <table>
    <tr class="title-row">
      <th style="color: rgb(78, 76, 222);"colspan="7">Les Données de la ligne</th>
    </tr>
    <tr>
      <th style="color: rgb(68, 68, 227);">Courant</th>
      <th style="color: rgb(58, 58, 220);">Tension</th>
      <th style="color: rgb(70, 70, 230);">Puissance</th>
      <th style="color: rgb(71, 71, 231);">PuissanceA</th>
      <th style="color: rgb(74, 74, 232);">Température</th>
      <th style="color: rgb(68, 68, 227);">Humidité</th>
      <th style="color: rgb(70, 70, 230);"> cosρ</th>
    </tr>
    <tr>
      <td id="COURANT"style="color: orange;">0</td>
      <td id="DDP"style="color: orange;">0V</td>
      <td id="PUISS"style="color: orange;">0W</td>
      <td id="PUISSA"style="color: orange;">0VA</td>
      <td id="TEMP"style="color: orange;">0°C</td>
      <td id="HUM"style="color: orange;">0%</td>
      <td id="Cos"style="color: orange;">0</td>
    </tr>
  </table>
  </div>

  
  <h3 style="color: rgba(64, 64, 202, 0.988);">CONTROLE ET COMMANDE DE LIGNES DE DISTRIBUTION</h3>
  
  <section class="command-section">
    <div class="station gombe">
      <h4 style="color: rgb(74, 5, 249);">Départ GOMBE</h4>
      <button class="activate" onclick="activerGombe()">Activer</button>
      <button class="desactivate" onclick="desactiverGombe()">Désactiver</button>
      <p><span id="etatGombe">En attente...</span></p>
    </div>
  
    <div class="station limete">
      <h4 style="color: rgb(52, 10, 241);">Départ LIMETE</h4>
      <button class="activate" onclick="activerLimete()">Activer</button>
      <button class="desactivate" onclick="desactiverLimete()">Désactiver</button>
      <p><span id="etatLimete">En attente...</span></p>
    </div>
  
    <div class="station barumbu">
      <h4 style="color: rgb(53, 10, 245);">Départ BARUMBU</h4>
      <button class="activate" onclick="activerBarumbu()">Activer</button>
      <button class="desactivate" onclick="desactiverBarumbu()">Désactiver</button>
      <p><span id="etatBarumbu">En attente...</span></p>
    </div>

    <div class="station tout">
      <h4 style="color: rgb(57, 9, 248);">Tous Les Départs </h4>
     <button id="btnActiverTout" class="activate" onclick="activertout()">Activer Tous les Départs</button>

      <button class="desactivate" onclick="desactivertout()">Désactiver Tous Les Départs</button>
      <p><span id="etatdéparts">En attente...</span></p>
    </div>
  </section>

<!-- Barre de navigation fixe -->
<div class="bottom-nav">
  <div class="nav-item active" onclick="window.location.href='index.html'">
    <i class="fas fa-home"></i>
  </div>
  <div class="nav-item" onclick="window.location.href='HBNK.html'">
    <i class="fas fa-sliders-h"></i>
  </div>
  <div class="nav-item" onclick="window.location.href='index3.html'">
    <i class="fas fa-chart-line"></i>
  </div>
 
</div>



  <script>
    parler("Bienvenue sur l’interface de contrôle et de commande du réseau électrique intelligent en R D C.");
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyArEB0lH1tz3OOvrgKzL0cypYfMpQVgPm0",
      authDomain: "maison-iot-b0dd6.firebaseapp.com",
      databaseURL: "https://maison-iot-b0dd6-default-rtdb.firebaseio.com",
      projectId: "maison-iot-b0dd6",
      storageBucket: "maison-iot-b0dd6.appspot.com",
      messagingSenderId: "838021465845",
      appId: "1:838021465845:web:b277f02fd883b0c23627bc",
      measurementId: "G-P697GH67M1"
    };
  
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  
    let Tension = 0;
    let Courant = 0;
  
    // Mise à jour des données capteurs
    database.ref("Data/Temperature").on("value", (snapshot) => {
      document.getElementById("TEMP").textContent = snapshot.val() + " °C";
    });
  
    database.ref("Data/hymidite").on("value", (snapshot) => {
      document.getElementById("HUM").textContent = snapshot.val() + " %";
    });
  
    database.ref("Data/Tension").on("value", (snapshot) => {
  Tension = snapshot.val();
  document.getElementById("DDP").textContent = Tension + " V";

  

  updatePower();
});
  
    database.ref("Data/Courant").on("value", (snapshot) => {
      Courant = snapshot.val();
      document.getElementById("COURANT").textContent = Courant + " A";
      updatePower();
    });
  
    function updatePower() {
      const F = 0.9;
      const puissance = Tension * Courant * F;
      const puissanceA = Tension * Courant;
  
      document.getElementById("PUISS").textContent = puissance.toFixed(2) + " W";
      document.getElementById("PUISSA").textContent = puissanceA.toFixed(2) + " VA";
      document.getElementById("Cos").textContent = F;
  
      database.ref("Data/puissance").set(puissance);
      database.ref("Data/puissanceA").set(puissanceA);
    }
      let modeSilencieux = false; // Pour contrôler si on doit parler ou non
// Fonction de synthèse vocale
function parler(message) {
  const utterance = new SpeechSynthesisUtterance(message);
  utterance.lang = "fr-FR"; // Français
  speechSynthesis.speak(utterance);
}

    // Fonction pour activer visuellement une station
function activerStation(station) {
  const activateBtn = document.querySelector(`.station.${station} .activate`);
  activateBtn.classList.add("active");
}

// Fonction pour désactiver visuellement une station
function desactiverStation(station) {
  const activateBtn = document.querySelector(`.station.${station} .activate`);
  activateBtn.classList.remove("active");
}

// Fonctions pour chaque départ
function activerGombe() {
  database.ref("Depars/Depart_GOMBE").set(1); // valeurs numériques
  activerStation("gombe");
  if (!modeSilencieux)parler("Le départ pour la commune de la Gombé ; est activé ");
}

function desactiverGombe() {
  database.ref("Depars/Depart_GOMBE").set(0);
  desactiverStation("gombe");
  if (!modeSilencieux)parler("Le départ pour la commune de la Gombé ; est désactivé ");
}

database.ref("Depars/Depart_GOMBE").on("value", (snapshot) => {
  const etat = snapshot.val();
  const etatGombeElem = document.getElementById("etatGombe");
  const activateBtn = document.querySelector(".station.gombe .activate");
  
  etatGombeElem.textContent = (etat == 1) ? "GOMBE est Activé" : "GOMBE est Désactivé";
  etatGombeElem.style.color = (etat == 1) ? "blue" : "red"; // couleur du texte
  // ou pour changer la couleur de fond à la place :
  // etatGombeElem.style.backgroundColor = (etat == 1) ? "yellow" : "green";
  
  if (etat == 1) {
    activateBtn.classList.add("active");
  } else {
    activateBtn.classList.remove("active");
  }

  verifierEtatGlobal();
});

function activerLimete() {
  database.ref("Depars/Depart_LIMETE").set(1);
  activerStation("limete");
  if (!modeSilencieux)parler("Le départ pour la commune de Limété  ; est activé ");
}

function desactiverLimete() {
  database.ref("Depars/Depart_LIMETE").set(0);
  desactiverStation("limete");
  if (!modeSilencieux)parler("Le départ pour la commune de Limété  ; est désactivé ");
}

database.ref("Depars/Depart_LIMETE").on("value", (snapshot) => {
  const etat = snapshot.val();
  const etatLimeteElem = document.getElementById("etatLimete");
  const activateBtn = document.querySelector(".station.limete .activate");

  etatLimeteElem.textContent = (etat == 1) ? "LIMETE est Activé" : "LIMETE est Désactivé";
  etatLimeteElem.style.color = (etat == 1) ? "blue" : "red"; // couleur du texte

  if (etat == 1) {
    activateBtn.classList.add("active");
  } else {
    activateBtn.classList.remove("active");
  }
  verifierEtatGlobal();
});

function activerBarumbu() {
  database.ref("Depars/Depart_BARUMBU").set(1);
  activerStation("barumbu");
  if (!modeSilencieux)parler("Le départ pour la commune de Baroumbou ; est activé ");
}

function desactiverBarumbu() {
  database.ref("Depars/Depart_BARUMBU").set(0);
  desactiverStation("barumbu");
  if (!modeSilencieux)parler("Le départ pour la commune de Baroumbou; est désactivé ");
}

database.ref("Depars/Depart_BARUMBU").on("value", (snapshot) => {
  const etat = snapshot.val();
  const etatBarumbuElem = document.getElementById("etatBarumbu");
  const activateBtn = document.querySelector(".station.barumbu .activate");

  etatBarumbuElem.textContent = (etat == 1) ? "BARUMBU est Activé" : "BARUMBU est Désactivé";
  etatBarumbuElem.style.color = (etat == 1) ? "blue" : "red"; // couleur du texte

  if (etat == 1) {
    activateBtn.classList.add("active");
  } else {
    activateBtn.classList.remove("active");
  }
  verifierEtatGlobal();
});

// Activer tous les départs
function activertout() {
  modeSilencieux = true;
  activerGombe();
  activerLimete();
  activerBarumbu();
  modeSilencieux = false;

  database.ref("Depars/Depart_TOUT").set(1);
  

  document.querySelectorAll("button.activate").forEach(btn => {
    btn.classList.add("active");
    
  });
  // Parler lorsque tous les départs sont activés
  parler("Tous les départs sont activés");
}

// Désactiver tous les départs
function desactivertout() {
   modeSilencieux = true;
  desactiverGombe();
  desactiverLimete();
  desactiverBarumbu();
   modeSilencieux = false;

  database.ref("Depars/Depart_TOUT").set(0);
  

  document.querySelectorAll("button.activate").forEach(btn => {
    btn.classList.remove("active");
  });
   if (Tension > 140) {

   parler("Tous les départs sont désactivés");
  }
   // Parler lorsque tous les départs sont activés
  //parler("Tous les départs sont désactivés");
}

// Vérification de l'état global de tous les départs
function verifierEtatGlobal() {
  database.ref("Depars").once("value").then((snapshot) => {
    const data = snapshot.val();
    const gombe = data.Depart_GOMBE;
    const limete = data.Depart_LIMETE;
    const barumbu = data.Depart_BARUMBU;
    const tout = data.Depart_TOUT;

    const etatGlobalElem = document.getElementById("etatdéparts");
    const btnActiverTout = document.getElementById("btnActiverTout");

    let texteGlobal = "";

  if (gombe == 1 && limete == 1 && barumbu == 1) {
    
  texteGlobal = "Tous les Départs sont Activés";
  etatGlobalElem.style.color = "blue";
  // rendre le bouton "Activer tout" jaune (classe active)
  btnActiverTout.classList.add("active");
  
  

} else if (gombe == 0 && limete == 0 && barumbu == 0) {
  texteGlobal = "Tous les Départs sont Désactivés";
  etatGlobalElem.style.color = "red";
  // retirer la classe "active" => vert par défaut
 btnActiverTout.classList.remove("active");

  }
else {
  texteGlobal = "Tous les Départs ne sont pas Activés";
  etatGlobalElem.style.color = "green";
  btnActiverTout.classList.remove("active");
  //parler("Tous les départs des communes; ne sont Activés  ");
}

   etatGlobalElem.textContent = texteGlobal;
  });
}

// Rendre les fonctions accessibles globalement
window.activerGombe = activerGombe;
window.desactiverGombe = desactiverGombe;
window.activerLimete = activerLimete;
window.desactiverLimete = desactiverLimete;
window.activerBarumbu = activerBarumbu;
window.desactiverBarumbu = desactiverBarumbu;
window.activertout = activertout;
window.desactivertout = desactivertout;



// ✅ Fonction pour faire parler le système
function parler(message) {
  const synthese = window.speechSynthesis;
  const voix = new SpeechSynthesisUtterance(message);
  voix.lang = "fr-FR";
  synthese.speak(voix);
}

let compteurIA = 0;

// ✅ Fonction principale qui lit les mesures, analyse et parle
function annoncerMesuresEtPrediction() {
  const courant = parseFloat(document.getElementById("COURANT").textContent);
  const tension = parseFloat(document.getElementById("DDP").textContent);
  const puissancee = parseFloat(document.getElementById("PUISS").textContent);
  const puissanceApparente = parseFloat(document.getElementById("PUISSA").textContent);
  const temperature = parseFloat(document.getElementById("TEMP").textContent);
  const humidite = parseFloat(document.getElementById("HUM").textContent);
  const cosPhi = parseFloat(document.getElementById("Cos").textContent);


  // 🔢 Incrément du compteur pour limiter la fréquence d'annonce
  compteurIA++;
  if (compteurIA < 13) return; // Exemple : toutes les 2 minutes si intervalle = 5 sec
  compteurIA = 0;

  // 🔍 Annonce des mesures actuelles
  let texteMesures =
    "Voici les mesures actuelles de la prédiction de l'état du système : " +
    `Le Courant est de  : ${courant} empère${courant > 1 ? "s" : ""}, ` +
    `La Tension est de : ${tension} volt${tension > 1 ? "s" : ""}, ` +
    `La Puissance active est de : ${puissancee} watt${puissancee > 1 ? "s" : ""}, ` +
    `La Puissance apparente est de : ${puissanceApparente} volt-empère${puissanceApparente > 1 ? "s" : ""}, ` +
    `La Température est de: ${temperature} degré${temperature > 1 ? "s" : ""} Celsius, ` +
    `L'Humidité est de : ${humidite}%, ` +
    `et le Facteur de puissance est de : ${cosPhi.toFixed(2)}.`;

  parler(texteMesures);

  // 📊 Analyse intelligente
  let estNormal = true;
  let anomalies = [];

  if ( courant > 30) {
    estNormal = false;
    anomalies.push("le courant est anormal");
  }

  if (tension < 200 || tension > 250) {
    estNormal = false;
    anomalies.push("la tension est hors de la plage normale");
  }

  if (puissancee > 10000) {
    estNormal = false;
    anomalies.push("la puissance dépasse 10 000 watts");
  }

  if (temperature < 10 || temperature > 45) {
    estNormal = false;
    anomalies.push("la température est hors norme");
  }

  if (humidite < 10 || humidite > 80) {
    estNormal = false;
    anomalies.push("le taux d'humidité est critique");
  }

  if (cosPhi < 0.7 || cosPhi > 1.0) {
    estNormal = false;
    anomalies.push("le facteur de puissance est inadéquat");
  }

  // 🔔 Résultat de l’analyse prédictive
  if (estNormal) {
    parler("Analyse de la prédiction IA : toutes les données sont normales. Le système fonctionne correctement.");
  } else {
    parler("Attention. Analyse de la prédiction IA : des anomalies ont été détectées apres l'Analyse de données. " + anomalies.join(", ") + ".");
  }

   // 📣 Annonce vocale de l’état des départs depuis Firebase
database.ref("Depars").once("value").then((snapshot) => {
  const data = snapshot.val();

  const etats = {
    Gombé: data.Depart_GOMBE,
    Limété: data.Depart_LIMETE,
    Baroumbou: data.Depart_BARUMBU
  };

  const activés = Object.entries(etats)
    .filter(([_, val]) => val == 1)
    .map(([commune, _]) => commune);

  const désactivés = Object.entries(etats)
    .filter(([_, val]) => val == 0)
    .map(([commune, _]) => commune);

  // 🔊 Annoncer les communes activées
  if (activés.length === 0) {
    parler("Tous les départs sont désactivés.");
  } else if (activés.length === 3) {
    parler("Tous les départs sont activés.");
  } else {
    const phraseActivés = activés.map(c => `la commune de ${c}`).join(", ");
    parler("Départs activés : " + phraseActivés + ".");
  }

  // 🔊 Annoncer les communes désactivées
  if (désactivés.length > 0 && désactivés.length < 3) {
    const phraseDésactivés = désactivés.map(c => `la commune de ${c}`).join(", ");
    parler("départs désactivés  : " + phraseDésactivés + ".");
  }
});

}

// ⏱️ Exécution périodique toutes les 5 secondes
setInterval(annoncerMesuresEtPrediction, 5000); // Exécute chaque 5 secondes
 
  
    

    // Fonction utilitaire pour générer une valeur flottante aléatoire entre min et max
function getRandomFloat(min, max) {
  return Math.random() * (max - min) + min;
}

// Fonction pour calculer et simuler le courant selon les départs activés
function simulerVariationCourant() {
  database.ref("Depars").once("value").then((snapshot) => {
    const data = snapshot.val();

    const actifs = [
      data.Depart_GOMBE,
      data.Depart_LIMETE,
      data.Depart_BARUMBU
    ];

    const nbActifs = actifs.filter(etat => etat === 1).length;

    let courantSimulé = 0;

    if (nbActifs === 0) {
      courantSimulé = 0.00;
    } else if (nbActifs === 1) {
      courantSimulé = getRandomFloat(4.00, 4.09);
    } else if (nbActifs === 2) {
      courantSimulé = getRandomFloat(8.00, 8.18);
    } else if (nbActifs === 3) {
      courantSimulé = getRandomFloat(12.00, 12.36);
    }

    // Mettre à jour Firebase avec la valeur simulée du courant
    database.ref("Data/Courant").set(parseFloat(courantSimulé.toFixed(2)));
  });
}

// Rafraîchir la valeur du courant toutes les 3 secondes
setInterval(simulerVariationCourant, 2000);








/*const db = firebase.database();
const dataRef = db.ref("Data");
const tensionRef = dataRef.child("Tension");

let ancienneTension = null;
let timeoutStagnation = null;

// Fonction pour réinitialiser les données
function resetDonneesFirebase() {
  console.warn("⚠️ Tension inchangée pendant 2 minutes. Données réinitialisées.");
  dataRef.update({
    Tension: 0,
    Courant: 0,
    Temperature: 0,
    hymidite: 0
  });
  timeoutStagnation = null;
}

// Fonction de surveillance de la tension
function surveillerVariationTension() {
  tensionRef.on("value", (snapshot) => {
    const tensionActuelle = snapshot.val();
    if (tensionActuelle == null) return;

    // Si la tension change → réinitialiser le timer
    if (ancienneTension !== null && tensionActuelle !== ancienneTension) {
      clearTimeout(timeoutStagnation);
      timeoutStagnation = setTimeout(resetDonneesFirebase, 1 * 60 * 1000); // 2 minutes
    }

    // Si la tension est stable (y compris 0) → lancer ou maintenir le timer
    if (ancienneTension === null || tensionActuelle === ancienneTension) {
      if (!timeoutStagnation) {
        timeoutStagnation = setTimeout(resetDonneesFirebase, 1 * 60 * 1000); // 2 minutes
      }
    }

    ancienneTension = tensionActuelle;
  });
}

// Démarrer la surveillance
surveillerVariationTension();
*/


setInterval(() => {
  if (Tension < 140) {
    console.warn("⚠️ Vérification périodique : tension inférieure à 140V, désactivation des départs.");
    desactivertout();
    //parler("Attention. La tension est inférieure à 140 volts. Tous les départs sont désactivés.");
  }
}, 5);  // toutes les 5 secondes 


    
  </script>
</body>
</html>  